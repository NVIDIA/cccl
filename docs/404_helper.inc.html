<ul>
    <div id="linkGen"></div>
</ul>
<script type="module">
    import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.mjs'
    // This page assumes that the user is already in a versioned subtree
    // It is no longer the root 404 handler and is instead delagated to.
    var localUri = window.location.pathname;
    var hostUrl = window.location.protocol + "//" + window.location.host

    let params = new URLSearchParams(document.location.search);

    var rootPathMatch = localUri.match(/^\/cccl\/(unstable|branch\/\d+\.\d+\.\d+)/)

    if (rootPathMatch === null) {
        rootPathMatch = "/cccl/unstable"
        console.log("Unexpected location:" + localUri)
    }

    var rootUrl = hostUrl + rootPath
    var pagelistUrl = rootUrl + "/pagelist.txt"

    // // Branch is versioned if it leads with `unstable` or `vX.Y.Z`
    // var isBranchVersioned = localUri.match(/^\/cccl\/(unstable|v\d+\.\d+\.\d+)/);

    // // If the branch is not versioned, we redirect to a versioned branch keeping the URI.
    // if (!isBranchVersioned) {
    //     window.location.href = hostUrl + '/' + localUri.replace(/^cccl\//g, "cccl/unstable");
    // }

    var searchString = params.get("path");

    if (searchString !== null) {
        fetch(pagelistUrl)
            .then((response) => response.text())
            .then((text) => {
                const pagelist = text.split(",")

                const options = {
                includeScore: true,
                distance: 100,
                threshold: 0.8,
                ignoreLocation: true
                }

                // cccl/device_vector.html => 'cccl 'device 'vector
                const query = searchString.replace(/\/|-|_/gi," '").replace(".html","")
                console.log("query:" + query)
                const fuse = new Fuse(pagelist, options)
                const result = fuse.search(query, {limit: 10})

                const listItem = '<li><a href=\"{2}{0}\">{0}</a> - Score: {1}</li>'.replace(/\{2\}/g, rootUrl + "/")
                document.getElementById('linkGen').innerHTML = ""
                result.forEach(element => {
                document.getElementById('linkGen').innerHTML += listItem.replace(/\{0\}/g, element.item).replace(/\{1\}/g, element.score.toFixed(2))
                });
            })
    }
</script>
