#!/usr/bin/env python3

##===----------------------------------------------------------------------===##
##
## Part of nvrtcc in CUDA Core Compute Libraries,
## under the Apache License v2.0 with LLVM Exceptions.
## See https://llvm.org/LICENSE.txt for license information.
## SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
## SPDX-FileCopyrightText: Copyright (c) 2026 NVIDIA CORPORATION & AFFILIATES.
##
##===----------------------------------------------------------------------===##

import argparse
import copy
import dataclasses
import enum
import os
import re
import shlex
import shutil
import subprocess
import sys


# Custom command line parser for NV compilers. Implemented according to:
# https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/#command-option-types-and-notation
#
# TODO: add support for -Idir1,dir2
class NvCommandLineParser:
    class Error(Exception):
        def __init__(self, message):
            super().__init__(message)

    class ArgType(enum.Enum):
        BOOL = 1
        SINGLE = 2
        LIST = 3

    @dataclasses.dataclass
    class ArgInfo:
        long_opt: str
        arg_type: ...
        default: ...

    @dataclasses.dataclass
    class State:
        opts_it: ...
        unknown_args: list[str]  # contains positional arguments, too
        args: dict

    def __init__(self):
        self.args = dict()

    def add_arg(self, short_opt: str, long_opt: str, arg_type: str, default=None):
        assert short_opt.startswith("-")
        assert long_opt.startswith("--")

        short_opt_no_prefix = short_opt.removeprefix("-")
        long_opt_no_prefix = long_opt.removeprefix("--")

        # If default value was not specified, set it to the default.
        if default is None:
            match arg_type:
                case NvCommandLineParser.ArgType.BOOL:
                    default = False
                case NvCommandLineParser.ArgType.SINGLE:
                    default = None
                case NvCommandLineParser.ArgType.LIST:
                    default = []

        if short_opt_no_prefix in self.args:
            raise NvCommandLineParser.Error("option already present")

        self.args[short_opt_no_prefix] = NvCommandLineParser.ArgInfo(
            long_opt_no_prefix, arg_type, default
        )

    def _set_arg(self, state: State, arg_id: str, arg_type: ArgType, value):
        match arg_type:
            case NvCommandLineParser.ArgType.BOOL:
                state.args[arg_id] = True
            case NvCommandLineParser.ArgType.SINGLE:
                state.args[arg_id] = value
            case NvCommandLineParser.ArgType.LIST:
                state.args[arg_id] += [value]

    def _parse_long_opt(self, state: State, opt: str):
        for short, data in self.args.items():
            if opt.startswith(data.long_opt):
                opt_value = opt.removeprefix(data.long_opt)
                if len(opt_value) == 0:
                    if data.arg_type == NvCommandLineParser.ArgType.BOOL:
                        self._set_arg(state, short, data.arg_type, True)
                    else:
                        self._set_arg(state, short, data.arg_type, next(state.opts_it))
                    return
                elif opt_value.startswith("="):
                    if data.arg_type == NvCommandLineParser.ArgType.BOOL:
                        raise NvCommandLineParser.Error(
                            "bool option type cannot have value"
                        )
                    self._set_arg(state, short, data.arg_type, opt_value[1:])
                    return
        state.unknown_args.append("--" + opt)

    def _parse_short_opt(self, state: State, opt: str):
        one_char_match_key = None
        one_char_match_value = None
        for short, data in self.args.items():
            if opt.startswith(short):
                opt_value = opt.removeprefix(short)
                if len(opt_value) == 0:
                    if data.arg_type == NvCommandLineParser.ArgType.BOOL:
                        self._set_arg(state, short, data.arg_type, True)
                    else:
                        self._set_arg(state, short, data.arg_type, next(state.opts_it))
                    return
                elif opt_value.startswith("="):
                    if data.arg_type == NvCommandLineParser.ArgType.BOOL:
                        raise NvCommandLineParser.Error(
                            "bool option type cannot have value"
                        )
                    self._set_arg(state, short, data.arg_type, opt_value[1:])
                    return

                # If the short opt is only 1 char long, we need to store the value first and continue searching for better match.
                if len(short) == 1:
                    one_char_match_key = short
                    one_char_match_value = opt_value

        # If there was no better match, use the 1 char match value.
        if one_char_match_key is not None:
            self._set_arg(
                state,
                one_char_match_key,
                self.args[one_char_match_key].arg_type,
                one_char_match_value,
            )
            return

        state.unknown_args.append("-" + opt)

    def _parse_opt(self, state: State, opt: str):
        if opt.startswith("--"):
            self._parse_long_opt(state, opt.removeprefix("--"))
        elif opt.startswith("-"):
            self._parse_short_opt(state, opt.removeprefix("-"))
        else:
            state.unknown_args.append(opt)

    def parse_known_args(self, opts: list[str]):
        state = NvCommandLineParser.State(iter(opts), [], dict())

        # Fill the args with default values.
        for short, data in self.args.items():
            state.args[short] = data.default

        try:
            while True:
                opt = next(state.opts_it)
                try:
                    self._parse_opt(state, opt)
                except StopIteration:
                    raise NvCommandLineParser.Error("missing argument value")
        except StopIteration:
            pass

        return state.args, state.unknown_args


class Nvrtcc:
    @staticmethod
    def _parse_nvrtcc_opts(opts):
        parser = NvCommandLineParser()

        parser.add_arg("-nvccbin", "--nvccbin", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-use-nvrtc", "--use-nvrtc", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-Xnvrtc", "--nvrtc-options", NvCommandLineParser.ArgType.LIST)

        return parser.parse_known_args(opts)

    @staticmethod
    def _get_nvcc_bin_abs_path(nvcc_bin_arg, env):
        if nvcc_bin_arg is None:
            nvcc_bin = env.get("NVRTCC_NVCC_BIN", "nvcc")
        else:
            nvcc_bin = nvcc_bin_arg

        if not os.path.isabs(nvcc_bin):
            nvcc_bin = shutil.which(nvcc_bin)

        return nvcc_bin

    @staticmethod
    def _parse_nvcc_opts(nvcc_opts):
        parser = NvCommandLineParser()

        # File and Path Specifications
        parser.add_arg("-o", "--output-file", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg(
            "-objtemp", "--objdir-as-tempdir", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg("-include", "--pre-include", NvCommandLineParser.ArgType.LIST)
        parser.add_arg("-l", "--library", NvCommandLineParser.ArgType.LIST)
        parser.add_arg("-D", "--define-macro", NvCommandLineParser.ArgType.LIST)
        parser.add_arg("-U", "--undefine-macro", NvCommandLineParser.ArgType.LIST)
        parser.add_arg("-I", "--include-path", NvCommandLineParser.ArgType.LIST)
        parser.add_arg("-isystem", "--system-include", NvCommandLineParser.ArgType.LIST)
        parser.add_arg("-L", "--library-path", NvCommandLineParser.ArgType.LIST)
        parser.add_arg(
            "-odir", "--output-directory", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg("-MF", "--dependency-output", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg(
            "-MP", "--generate-dependency-targets", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-ccbin", "--compiler-bindir", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-allow-unsupported-compiler",
            "--allow-unsupported-compiler",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-arbin", "--archiver-binary", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg("-cudart", "--cudart", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-cudadevrt", "--cudadevrt", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg(
            "-ldir", "--libdevice-directory", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-target-dir", "--target-directory", NvCommandLineParser.ArgType.SINGLE
        )

        # Options for Specifying the Compilation Phase
        parser.add_arg("-link", "--link", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-lib", "--lib", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-dlink", "--device-link", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-dc", "--device-c", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-dw", "--device-w", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-cuda", "--cuda", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-c", "--compile", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-fatbin", "--fatbin", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-cubin", "--cubin", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-ptx", "--ptx", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-E", "--preprocess", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg(
            "-M", "--generate-dependencies", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-MM", "--generate-nonsystem-dependencies", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-MD",
            "--generate-dependencies-with-compile",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-MMD",
            "--generate-nonsystem-dependencies-with-compile",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg("-optix-ir", "--optix-ir", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-ltoir", "--ltoir", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-run", "--run", NvCommandLineParser.ArgType.BOOL)

        # Options for Specifying Behavior of Compiler/Linker
        parser.add_arg("-pg", "--profile", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-g", "--debug", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-G", "--device-debug", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg(
            "-lineinfo", "--generate-line-info", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-opt-info", "--optimization-info", NvCommandLineParser.ArgType.LIST
        )
        parser.add_arg("-O", "--optimize", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-Ofc", "--Ofast-compile", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-dopt", "--dopt", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-dlto", "--dlink-time-opt", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-lto", "--lto", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg(
            "-gen-opt-lto", "--gen-opt-lto", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-ftemplate-backtrace-limit",
            "--ftemplate-backtrace-limit",
            NvCommandLineParser.ArgType.SINGLE,
        )
        parser.add_arg(
            "-ftemplate-depth", "--ftemplate-depth", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg("-noeh", "--no-exceptions", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-shared", "--shared", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-x", "--x", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-std", "--std", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg(
            "-nohdinitlist",
            "--no-host-device-initializer-list",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-nohdmoveforward",
            "--no-host-device-move-forward",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-expt-relaxed-constexpr",
            "--expt-relaxed-constexpr",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-extended-lambda", "--extended-lambda", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-expt-extended-lambda",
            "--expt-extended-lambda",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg("-m", "--machine", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-m64", "--m64", NvCommandLineParser.ArgType.BOOL)

        # Options for passing specific phase options
        parser.add_arg(
            "-Xcompiler", "--compiler-options", NvCommandLineParser.ArgType.LIST
        )
        parser.add_arg("-Xlinker", "--linker-options", NvCommandLineParser.ArgType.LIST)
        parser.add_arg(
            "-Xarchive", "--archive-options", NvCommandLineParser.ArgType.LIST
        )
        parser.add_arg("-Xptxas", "--ptxas-options", NvCommandLineParser.ArgType.LIST)
        parser.add_arg("-Xnvlink", "--nvlink-options", NvCommandLineParser.ArgType.LIST)

        # Miscellaneous options for guiding the compiler driver.
        parser.add_arg(
            "-static-global-template-stub",
            "--static-global-template-stub",
            NvCommandLineParser.ArgType.SINGLE,
        )
        parser.add_arg(
            "-device-entity-has-hidden-visibility",
            "--device-entity-has-hidden-visibility",
            NvCommandLineParser.ArgType.SINGLE,
        )
        parser.add_arg(
            "-forward-unknown-to-host-compiler",
            "--forward-unknown-to-host-compiler",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-forward-unknown-to-host-linker",
            "--forward-unknown-to-host-linker",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-forward-unknown-opts",
            "--forward-unknown-opts",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-noprof", "--dont-use-profile", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg("-dryrun", "--dryrun", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-v", "--verbose", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-t", "--threads", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg(
            "-split-compile", "--split-compile", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-split-compile-extended",
            "--split-compile-extended",
            NvCommandLineParser.ArgType.SINGLE,
        )
        parser.add_arg(
            "-fdevice-syntax-only",
            "--fdevice-syntax-only",
            NvCommandLineParser.ArgType.SINGLE,
        )
        parser.add_arg(
            "-fdevice-time-trace",
            "--fdevice-time-trace",
            NvCommandLineParser.ArgType.SINGLE,
        )
        parser.add_arg("-keep", "--keep", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-keep-dir", "--keep-dir", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-save-temps", "--save-temps", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-clean", "--clean-targets", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-time", "--time", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-run-args", "--run-args", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg(
            "-idp", "--input-drive-prefix", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-ddp", "--dependency-drive-prefix", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg("-dp", "--drive-prefix", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg(
            "-MT", "--dependency-target-name", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-no-align-double", "--no-align-double", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg("-nodlink", "--no-device-link", NvCommandLineParser.ArgType.BOOL)

        # Options for steering GPU code generation.
        parser.add_arg("-arch", "--gpu-architecture", NvCommandLineParser.ArgType.LIST)
        parser.add_arg("-code", "--gpu-code", NvCommandLineParser.ArgType.LIST)
        parser.add_arg("-gencode", "--generate-code", NvCommandLineParser.ArgType.LIST)
        parser.add_arg(
            "-rdc", "--relocatable-device-code", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg("-e", "--entries", NvCommandLineParser.ArgType.LIST)
        parser.add_arg(
            "-maxrregcount", "--maxrregcount", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-use_fast_math", "--use_fast_math", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg("-ftz", "--ftz", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-prec-div", "--prec-div", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-prec-sqrt", "--prec-sqrt", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg("-fmad", "--fmad", NvCommandLineParser.ArgType.SINGLE)
        parser.add_arg(
            "-extra-device-vectorization",
            "--extra-device-vectorization",
            NvCommandLineParser.ArgType.BOOL,
        )

        # Options for steering cuda compilation.
        parser.add_arg(
            "-default-stream", "--default-stream", NvCommandLineParser.ArgType.SINGLE
        )

        # Generic tool options.
        parser.add_arg("-w", "--disable-warnings", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg(
            "-keep-device-functions",
            "--keep-device-functions",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-src-in-ptx", "--source-in-ptx", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg("-restrict", "--restrict", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-Wreorder", "--Wreorder", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg(
            "-Wdefault-stream-launch",
            "--Wdefault-stream-launch",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-Wmissing-launch-bounds",
            "--Wmissing-launch-bounds",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-Wext-lambda-captures-this",
            "--Wext-lambda-captures-this",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-Wno-deprecated-declarations",
            "--Wno-deprecated-declarations",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg(
            "-Wno-deprecated-gpu-targets",
            "--Wno-deprecated-gpu-targets",
            NvCommandLineParser.ArgType.BOOL,
        )
        parser.add_arg("-Werror", "--Werror", NvCommandLineParser.ArgType.LIST)
        parser.add_arg(
            "-res-usage", "--resource-usage", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-ewp", "--extensible-whole-program", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-no-compress", "--no-compress", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg("-qpp-config", "--qpp-config", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg(
            "-astoolpatch", "--compile-as-tools-patch", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg("-code-ls", "--list-gpu-code", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-arch-ls", "--list-gpu-arch", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg(
            "-err-no", "--display-error-number", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-no-err-no", "--no-display-error-number", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg("-diag-error", "--diag-error", NvCommandLineParser.ArgType.LIST)
        parser.add_arg(
            "-diag-suppress", "--diag-suppress", NvCommandLineParser.ArgType.LIST
        )
        parser.add_arg("-diag-warn", "--diag-warn", NvCommandLineParser.ArgType.LIST)
        parser.add_arg(
            "-hls", "--host-linker-script", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-aug-hls", "--augment-host-linker-script", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg("-r", "--relocatable-link", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg(
            "-brief-diag", "--brief-diagnostics", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-jtd", "--jump-table-density", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-reloc-ptx", "--relocatable-ptx", NvCommandLineParser.ArgType.BOOL
        )
        parser.add_arg(
            "-device-stack-protector",
            "--device-stack-protector",
            NvCommandLineParser.ArgType.SINGLE,
        )
        parser.add_arg(
            "-compress-mode", "--compress-mode", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-frandom-seed", "--frandom-seed", NvCommandLineParser.ArgType.SINGLE
        )
        parser.add_arg(
            "-fdevice-sanitize",
            "--fdevice-sanitize",
            NvCommandLineParser.ArgType.SINGLE,
        )
        parser.add_arg("-jobserver", "--jobserver", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-h", "--help", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-V", "--version", NvCommandLineParser.ArgType.BOOL)
        parser.add_arg("-optf", "--options-file", NvCommandLineParser.ArgType.LIST)

        return parser.parse_known_args(nvcc_opts)[0]

    def __init__(self, opts: list[str], env):
        args, nvcc_opts = Nvrtcc._parse_nvrtcc_opts(opts)

        self.nvcc_bin = Nvrtcc._get_nvcc_bin_abs_path(args["nvccbin"], env)
        self.use_nvrtc = args["use-nvrtc"]
        self.nvrtc_opts = args["Xnvrtc"]
        self.nvcc_opts = ["-D__NVRTCC__"] + nvcc_opts
        self.nvcc_args = Nvrtcc._parse_nvcc_opts(self.nvcc_opts)
        self.device_compile_bin = os.path.join(
            os.path.dirname(__file__), "nvrtcc_device_compiler"
        )
        self.nvrtc_lib = os.path.join(
            os.path.dirname(os.path.dirname(self.nvcc_bin)), "lib64", "libnvrtc.so"
        )
        self.env = env

        # Clear environment variables that prepend/append nvcc flags.
        self.env.pop("NVCC_PREPEND_FLAGS", None)
        self.env.pop("NVCC_APPEND_FLAGS", None)

    @staticmethod
    def _emit_error(msg, retcode=-1):
        print(f"nvrtcc error: {msg}", file=sys.stderr)
        sys.exit(retcode)

    @staticmethod
    def _emit_warning(msg):
        print(f"nvrtcc warning: {msg}", file=sys.stderr)

    def _check_nvcc_args(self):
        if self.nvcc_args["optix-ir"]:
            Nvrtcc._emit_error(
                "compiling to Optix IR with nvrtc is currently unsupported"
            )

        if (
            self.nvcc_args["ltoir"]
            or self.nvcc_args["dlto"]
            or self.nvcc_args["gen-opt-lto"]
        ):
            Nvrtcc._emit_error(
                "compiling to LTO IR with nvrtc is currently unsupported"
            )

        if self.nvcc_args["expt-relaxed-constexpr"]:
            Nvrtcc._emit_error("relaxed constexpr is unsupported with nvrtc")

        if self.nvcc_args["extended-lambda"] or self.nvcc_args["expt-extended-lambda"]:
            Nvrtcc._emit_error(
                "extended lambda declarations are unsupported with nvrtc"
            )

        if self.nvcc_args["keep-device-functions"]:
            Nvrtcc._emit_error("keeping device functions is unsupported with nvrtc")

        if self.nvcc_args["optf"]:
            Nvrtcc._emit_error("passing command line options via file is not supported")

    def _get_nvcc_cmd_list(self) -> list[str]:
        run_result = subprocess.run(
            [self.nvcc_bin] + self.nvcc_opts + ["-dryrun"],
            stderr=subprocess.PIPE,
            env=self.env,
        )
        if run_result.returncode != 0:
            Nvrtcc._emit_error(
                "failed to retrieve nvcc command list", run_result.returncode
            )

        lines = run_result.stderr.decode().splitlines()
        return [line.removeprefix("#$ ") for line in lines]

    def _print_if_verbose(self, msg, **kwargs):
        if self.nvcc_args["v"]:
            print(msg, **kwargs)

    @staticmethod
    def _is_comment(cmd):
        return cmd.startswith("--")

    @staticmethod
    def _is_env_var_assign(cmd):
        return re.match(r"^[a-zA-Z0-9_]+=", cmd)

    @staticmethod
    def _split_cmd(cmd):
        result = shlex.split(cmd)
        return result[0], result[1:]

    @staticmethod
    def _parse_ccbin_invocation(opts):
        arch_list = None

        arch_list_def = [x for x in opts if x.startswith("-D__CUDA_ARCH_LIST__=")]
        if arch_list_def:
            assert len(arch_list_def) == 1
            arch_list = arch_list_def[0].removeprefix("-D__CUDA_ARCH_LIST__=")

        return argparse.Namespace(arch_list=arch_list)

    @staticmethod
    def _parse_cicc_invocation(opts):
        parser = argparse.ArgumentParser(allow_abbrev=False)

        # Positional arguments.
        parser.add_argument("file", nargs="*")

        # Recognized used arguments.
        parser.add_argument("-o", "--output-file", type=str)
        parser.add_argument("--orig_src_file_name", type=str)
        parser.add_argument("--orig_src_path_name", type=str)
        parser.add_argument("--c++17", dest="cxx17", action="store_true")
        parser.add_argument("--c++20", dest="cxx20", action="store_true")
        parser.add_argument("--c++23", dest="cxx23", action="store_true")
        parser.add_argument("-arch", type=str)
        parser.add_argument("-maxreg", type=int)
        parser.add_argument("-ftz", type=int)
        parser.add_argument("-prec_div", type=int)
        parser.add_argument("-prec_sqrt", type=int)
        parser.add_argument("-fmad", type=int)
        parser.add_argument("--device-c", action="store_true")
        parser.add_argument("--partial-link", action="store_true")
        parser.add_argument("--debug_mode", action="store_true")
        parser.add_argument("-generate-line-info", action="store_true")
        parser.add_argument("-O0", dest="dopt", action="store_false", default=True)
        parser.add_argument("--Ofast-compile", type=str)
        parser.add_argument("--frandom-seed", nargs=1, type=str)
        parser.add_argument("-extra-device-vectorization", action="store_true")
        parser.add_argument("-jump-table-density", type=int)
        parser.add_argument("-w", action="store_true")
        parser.add_argument("-kernel-params-are-restrict", action="store_true")
        parser.add_argument("-inline-info", action="store_true")
        parser.add_argument("--display_error_number", action="store_true")
        parser.add_argument("-diag_error", "--diag_error", action="append", default=[])
        parser.add_argument(
            "-diag_suppress", "--diag_suppress", action="append", default=[]
        )
        parser.add_argument("-diag_warn", "--diag_warn", action="append", default=[])
        parser.add_argument("--brief_diagnostics", action="store_true")
        parser.add_argument("-split-compile", nargs=1)
        parser.add_argument("--device-time-trace", nargs=1)
        parser.add_argument("--promote_warnings", action="store_true")

        # Recognized ignored arguments.
        parser.add_argument("--static-host-stub", action="store_true")
        parser.add_argument("--host-stub-linkage-explicit", action="store_true")
        parser.add_argument("--device-hidden-visibility", action="store_true")
        parser.add_argument("--gnu_version")
        parser.add_argument("--allow_managed", action="store_true")
        parser.add_argument("-m64", action="store_true")
        parser.add_argument("--no-version-ident", action="store_true")
        parser.add_argument("--include_file_name")
        parser.add_argument("-tused", action="store_true")
        parser.add_argument("--module_id_file_name")
        parser.add_argument("--gen_c_file_name")
        parser.add_argument("--stub_file_name")
        parser.add_argument("--gen_device_file_name")
        parser.add_argument("--keep-device-functions", action="store_true")
        parser.add_argument("--gen_module_id_file", action="store_true")
        parser.add_argument("--relaxed_constexpr", action="store_true")
        parser.add_argument("--pending_instantiations", nargs=1)
        parser.add_argument("--extended-lambda", action="store_true")

        return parser.parse_args(opts)

    def _invoke_nvrtc(self, ccbin_args, cicc_args):
        cc = int(cicc_args.arch.removeprefix("compute_"))

        nvrtc_opts = copy.deepcopy(self.nvrtc_opts)

        # Remove -device-float128 for architectures with cc < 100.
        if cc < 100:
            nvrtc_opts = list(
                filter(
                    lambda x: x != "-device-float128" and x != "--device-float128",
                    nvrtc_opts,
                )
            )

        cmd = [self.device_compile_bin]

        # Positional arguments
        cmd += [self.nvrtc_lib]
        cmd += [cicc_args.orig_src_path_name]
        cmd += [cicc_args.orig_src_file_name]
        cmd += [cicc_args.output_file]
        cmd += [ccbin_args.arch_list]

        # Add nvrtc options passed by -Xnvrtc
        cmd += nvrtc_opts

        # Compilation targets
        cmd += [f"-arch={cicc_args.arch}"]
        cmd += ["-dc"] if cicc_args.device_c else []
        cmd += ["-ewp"] if self.nvcc_args["ewp"] else []

        # Debugging support
        cmd += ["-G"] if cicc_args.debug_mode else []
        cmd += ["-lineinfo"] if cicc_args.generate_line_info else []

        # Code generation
        cmd += ["-dopt=on"] if cicc_args.dopt else []
        cmd += [f"-Ofc={cicc_args.Ofast_compile}"] if cicc_args.Ofast_compile else []
        cmd += [f"-maxrregcount={cicc_args.maxreg}"] if cicc_args.maxreg else []
        cmd += [f"-ftz={'true' if cicc_args.ftz else 'false'}"]
        cmd += [f"-prec-sqrt={'true' if cicc_args.prec_sqrt else 'false'}"]
        cmd += [f"-prec-div={'true' if cicc_args.prec_div else 'false'}"]
        cmd += [f"-fmad={'true' if cicc_args.fmad else 'false'}"]
        cmd += (
            ["-extra-device-vectorization"]
            if cicc_args.extra_device_vectorization
            else []
        )
        cmd += (
            [f"-jtd={cicc_args.jump_table_density}"]
            if cicc_args.jump_table_density
            else []
        )
        cmd += (
            ["-frandom-seed", cicc_args.frandom_seed] if cicc_args.frandom_seed else []
        )

        # Preprocessing
        cmd += [f"-D{x}" for x in self.nvcc_args["D"]]
        cmd += [f"-U{x}" for x in self.nvcc_args["U"]]
        cmd += [f"-I{x}" for x in self.nvcc_args["I"]]
        cmd += [f"-I{x}" for x in self.nvcc_args["isystem"]]
        cmd += [f"-include={x}" for x in self.nvcc_args["include"]]

        # Language Dialect
        cmd += ["-std=c++17"] if cicc_args.cxx17 else []
        cmd += ["-std=c++20"] if cicc_args.cxx20 else []
        cmd += ["-std=c++23"] if cicc_args.cxx23 else []

        # Misc
        cmd += ["-w"] if cicc_args.w else []
        cmd += ["-Werror=all-warnings"] if cicc_args.promote_warnings else []
        cmd += ["-restrict"] if cicc_args.kernel_params_are_restrict else []
        cmd += ["-opt-info=inline"] if cicc_args.inline_info else []
        cmd += ["-no-err-no"] if not cicc_args.display_error_number else []
        cmd += [f"-diag-error={diag}" for diag in cicc_args.diag_error]
        cmd += [f"-diag-suppress={diag}" for diag in cicc_args.diag_suppress]
        # cmd += [f'-diag-warn={diag}' for diag in cicc_args.diag_warn]
        cmd += ["-brief_diag=true"] if cicc_args.brief_diagnostics else []
        cmd += [f"-time={self.nvcc_args['time']}"] if self.nvcc_args["time"] else []
        cmd += (
            [f"-split-compile={cicc_args.split_compile}"]
            if cicc_args.split_compile
            else []
        )
        cmd += (
            [f"-fdevice-time-trace={cicc_args.device_time_trace}"]
            if cicc_args.device_time_trace
            else []
        )

        # Run the nvrtc compilation.
        self._print_if_verbose(f"#$ {' '.join(cmd)}")
        if not self.nvcc_args["dryrun"]:
            run_result = subprocess.run(cmd, env=self.env)
            if run_result.returncode != 0:
                sys.exit(run_result.returncode)

    def _run_nvrtcc(self):
        if self.nvcc_args["h"]:
            print("TOOD: print help")
            sys.exit(0)

        Nvrtcc._check_nvcc_args(self)

        for cmd in self._get_nvcc_cmd_list():
            self._print_if_verbose(f"#$ {cmd}")

            if not self.nvcc_args["dryrun"] and Nvrtcc._is_comment(cmd):
                continue

            if not self.nvcc_args["dryrun"] and Nvrtcc._is_env_var_assign(cmd):
                os.environ[cmd.split("=")[0]] = "".join(cmd.split("=")[1:])
                continue

            bin, opts = Nvrtcc._split_cmd(cmd)

            if not self.nvcc_args["dryrun"]:
                # For some reason nvcc produces rm command that can fail if the file doesn't exist, so we just ignore the return value and output.
                if re.match(r"^rm$", bin):
                    subprocess.run(
                        [bin] + opts,
                        stdout=subprocess.DEVNULL,
                        stderr=subprocess.DEVNULL,
                        env=self.env,
                    )
                else:
                    run_result = subprocess.run(
                        [os.path.expandvars(bin)] + opts, env=self.env
                    )
                    if run_result.returncode != 0:
                        sys.exit(run_result.returncode)

            if re.match(r"^(gcc|clang|nvc\+\+|cl\.exe)$", bin):
                ccbin_args = Nvrtcc._parse_ccbin_invocation(opts)
            elif re.match(r"^.*cicc$", bin):
                cicc_args = Nvrtcc._parse_cicc_invocation(opts)
                self._invoke_nvrtc(ccbin_args, cicc_args)

    def _run_nvcc(self):
        run_result = subprocess.run([self.nvcc_bin] + self.nvcc_opts, env=self.env)
        if run_result.returncode != 0:
            sys.exit(run_result.returncode)

    def run(self):
        self._run_nvrtcc() if self.use_nvrtc else self._run_nvcc()


if __name__ == "__main__":
    Nvrtcc(sys.argv[1:], os.environ).run()
    sys.exit(0)
