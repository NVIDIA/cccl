name: Run as coder user

defaults:
  run:
    shell: bash -exo pipefail {0}


on:
  workflow_call:
    inputs:
      name: {type: string, required: true}
      image: {type: string, required: true}
      runner: {type: string, required: true}
      command: {type: string, required: true}
      env: { type: string, required: false, default: "" }

jobs:
  run-as-coder:
    name: ${{inputs.name}}
    runs-on: ${{inputs.runner}}
    container:
      options: -u coder
      image: ${{inputs.image}}
      env:
        NVIDIA_VISIBLE_DEVICES: ${{ env.NVIDIA_VISIBLE_DEVICES }}
    permissions:
      id-token: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - name: Add NVCC problem matcher
        run: |
          echo "::add-matcher::cccl/.github/problem-matchers/problem-matcher.json"
      - name: Configure credentials and environment variables for sccache
        uses: ./cccl/.github/actions/configure_cccl_sccache
      - name: Run command
        shell: bash
        run: |
            set -eo pipefail
            echo -e "\e[1;34mRunning as 'coder' user in $(pwd):\e[0m"
            echo -e "\e[1;34m${{inputs.command}}\e[0m"
            eval "${{inputs.command}}" || exit_code=$?
            if [ ! -z "$exit_code" ]; then
                echo -e "::group::️❗ \e[1;31mInstructions to reproduce failure\e[0m"
                echo "::error::Error! To checkout the corresponding code and reproduce locally, run the following commands:"
                echo "git clone --branch $GITHUB_REF_NAME --single-branch --recurse-submodules https://github.com/$GITHUB_REPOSITORY.git && cd $(echo $GITHUB_REPOSITORY | cut -d'/' -f2) && git checkout $GITHUB_SHA"
                echo "docker run --rm -it --gpus all --pull=always --volume \$PWD:/repo --workdir /repo ${{ inputs.image }} ${{inputs.command}}"
                echo "::endgroup::"
                exit $exit_code
            fi

