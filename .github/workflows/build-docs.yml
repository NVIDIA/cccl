name: Deploy CCCL Documentation

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  # Reusable workflow for PR previews
  workflow_call:
    inputs:
      destination_dir:
        description: "Destination directory for deployment"
        required: false
        default: "docs"
        type: string

# Sets permissions of the GITHUB_TOKEN to allow GitHub Pages deployment and PR comments
permissions:
  contents: write
  pull-requests: write
  pages: write

# Serialize deploy/cleanup for same PR to prevent races
concurrency:
  group: ${{ 'pages-main' }}
  cancel-in-progress: false

jobs:
  # Build and deploy job
  build-and-deploy:
    runs-on: ${{ github.repository == 'NVIDIA/cccl' && 'linux-amd64-cpu32' || 'ubuntu-latest' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Build docs
        uses: ./.github/actions/docs-build
        with:
          upload_workflow_artifact: true

      - name: Set commit message
        id: commit-msg
        run: |
          echo "message=Deploy main docs (${{ github.sha }})" >> $GITHUB_OUTPUT

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: gh-pages
          destination_dir: ${{ inputs.destination_dir || 'docs' }}
          keep_files: false
          force_orphan: true
          enable_jekyll: false
          commit_message: ${{ steps.commit-msg.outputs.message }}
