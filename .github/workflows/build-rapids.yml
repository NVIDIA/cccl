name: Build all RAPIDS repositories

on:
  workflow_call:

jobs:
  check-event:
    name: Check GH Event
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.check_gh_event.outputs.ok }}
    steps:
      - id: check_gh_event
        name: Check GH Event
        shell: bash
        run: |
          [[ '${{ github.event_name }}' == 'push' && '${{ github.repository }}' == 'NVIDIA/cccl' ]] || \
          [[ '${{ github.event_name }}' == 'schedule' && '${{ github.repository }}' == 'NVIDIA/cccl' ]] || \
          [[ '${{ github.event_name }}' == 'pull_request' && '${{ github.repository }}' != 'NVIDIA/cccl' ]] \
          && echo "ok=true"  | tee -a $GITHUB_OUTPUT \
          || echo "ok=false" | tee -a $GITHUB_OUTPUT;

  build-rapids:
    name: Build RAPIDS (${{ matrix.libs }})
    if: needs.check-event.outputs.ok == 'true'
    needs: check-event
    secrets: inherit
    # TODO: this is temporary
    uses: ./.github/workflows/build-in-devcontainer.yml
    # uses: rapidsai/shared-workflows/.github/workflows/build-in-devcontainer.yaml@branch-24.06
    strategy:
      fail-fast: false
      matrix:
        include:
          - { libs: 'rmm KvikIO cudf cudf_kafka cuspatial',         args: 'BUILD_TESTS BUILD_BENCHMARKS' }
          - { libs: 'rmm ucxx raft cuvs',                           args: 'BUILD_TESTS BUILD_BENCHMARKS BUILD_ANN_BENCH BUILD_PRIMS_BENCH' }
          - { libs: 'rmm ucxx raft cumlprims_mg cuml',              args: 'BUILD_TESTS BUILD_BENCHMARKS BUILD_ANN_BENCH BUILD_PRIMS_BENCH' }
          - { libs: 'rmm ucxx raft cugraph-ops wholegraph cugraph', args: 'BUILD_TESTS BUILD_BENCHMARKS BUILD_ANN_BENCH BUILD_PRIMS_BENCH BUILD_CUGRAPH_MG_TESTS' }
    permissions:
      actions: read
      packages: read
      id-token: write
      contents: read
      pull-requests: read
    with:
      dir: 'ci/rapids'
      arch: '["amd64"]'
      cuda: '["12.2"]'
      pkgr: '["conda"]'
      node_type: cpu32
      extra-repo-deploy-key: RAPIDSAI_CUMLPRIMS_DEPLOY_KEY
      extra-repo-deploy-key-2: RAPIDSAI_CUGRAPH_OPS_DEPLOY_KEY
      env: |
        CI=true
        RAPIDS_LIBS=${{ matrix.libs }}
        RAPIDS_TEST_OPTIONS=${{ matrix.args }}
        RAPIDS_cmake_GIT_REPO={"upstream": "trxcllnt", "tag": "fea/cccl-2.5"}
        RAPIDS_cudf_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_cudf_kafka_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_cugraph_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_cugraph_ops_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_cuml_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_cumlprims_mg_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_cuspatial_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_cuvs_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_KvikIO_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_raft_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_rmm_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
        RAPIDS_ucxx_GIT_REPO={"upstream": "rapidsai", "tag": "branch-0.39"}
        RAPIDS_wholegraph_GIT_REPO={"upstream": "rapidsai", "tag": "branch-24.08"}
      build_command: |
        declare -a failures
        declare -A failures_map

        # Configure and build each lib with -DBUILD_TESTS=OFF, then again with -DBUILD_TESTS=ON
        for RAPIDS_ENABLE_TESTS in OFF ON; do
          ~/cccl/ci/rapids/post-create-command.sh
          for lib in ${{ matrix.libs }}; do
            sccache -z
            if ! configure-${lib}-cpp || ! build-${lib}-cpp; then
              if ! test -v failures_map["${lib}"]; then
                failures+=("${lib}")
                failures_map["${lib}"]=1
              fi
            fi
            sccache --show-adv-stats
          done
        done

        # Print failures and exit
        if test ${#failures[@]} -gt 0; then
          echo "::error:: Failures: ${failures[*]}"
          echo -e "::group::️❗ \e[1;31mInstructions to Reproduce CI Failure Locally\e[0m"
          echo "::error:: To replicate this failure locally, follow the steps below:"
          echo "1. Clone the repository, and navigate to the correct branch and commit:"
          echo "   git clone --branch $GITHUB_REF_NAME --single-branch https://github.com/$GITHUB_REPOSITORY.git && cd $(echo $GITHUB_REPOSITORY | cut -d'/' -f2) && git checkout $GITHUB_SHA"
          echo ""
          echo "2. Run the failed command inside the same Docker container used by this CI job:"
          cat <<__EOF
             RAPIDS_LIBS='${RAPIDS_LIBS}' \\
             RAPIDS_TEST_OPTIONS='${RAPIDS_TEST_OPTIONS}' \\
          $(for lib in cmake ${RAPIDS_LIBS}; do var=RAPIDS_${lib//-/_}_GIT_REPO; echo "   $var='${!var}' \\"; done)
             .devcontainer/launch.sh -d -c 12.2 -H rapids-conda -- ./ci/rapids/rapids-entrypoint.sh \\
             /bin/bash -li -c 'uninstall-all -j -qqq && clean-all -j && build-all -j -v || exec /bin/bash -li'
        __EOF
          echo ""
          echo "For additional information, see:"
          echo "   - DevContainer Documentation: https://github.com/NVIDIA/cccl/blob/main/.devcontainer/README.md"
          echo "   - Continuous Integration (CI) Overview: https://github.com/NVIDIA/cccl/blob/main/ci-overview.md"
          exit 1
        fi
